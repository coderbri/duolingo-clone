# 04 Setting up Authentication

## Setting up Clerk Authentication

To enable authentication in our app, we will use [Clerk Authentication and User Management](https://clerk.com/). After signing in to our account on the platform, select the option "**New Application**". Title the application as "Lingo" (the name of our current project) and choose the sign-in options: email and Google. Then, click on "Create Application".

It will then redirect to the new application's dashboard. The first thing we need to do is to copy the environment keys. But before we do that, we need to create a new environment file. Ensure that **`.env`** files are gitignored and add `.env` below it.

```
# local env files
.env*.local
.env
```

Now, we can go to the **Lingo project folder** and create a **`.env`** file. Paste the two environment keys provided upon creating the app on Clerk.

Next, let's follow the [Next.js Quickstart Guide](https://clerk.com/docs/references/nextjs/custom-signup-signin-pages) on the Clerk platform. Since we've already installed the app router during the project setup, we'll start by installing the next.js package for Clerk into our project in a separate terminal:

```bash
npm install @clerk/nextjs
```

### Adding `ClerkProvider`

We add the `ClerkProvider` inside our **layout.tsx** file of the `app/` directory.

#### `app/layout.tsx`

```tsx
import type { Metadata } from "next";
import { Nunito } from "next/font/google";
import { ClerkProvider } from '@clerk/nextjs'
import "./globals.css";

const font = Nunito({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body className={font.className}>{children}</body>
      </html>
    </ClerkProvider>
  );
}
```

### Adding Clerk Middleware

Now we add the middleware. Caution is needed when creating this file because it needs to be placed in the root of our project and must be named **`middleware.ts`** as "middleware" is a reserved keyword.

#### `lingo/middleware.ts`

```tsx
import { clerkMiddleware } from "@clerk/nextjs/server";

export default clerkMiddleware();

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
};
```


### Using Loader Component for Authentication Loading State

In the Hero Page (`app/(marketing)/page.tsx`), we use the `Loader` component from `lucide-react` to display a loading indicator while the authentication state is being checked. This ensures a smooth user experience by indicating that the authentication process is ongoing.

```tsx
<ClerkLoading>
    <Loader className="h-5 w-5 text-muted-foreground animate-spin" />
</ClerkLoading>
```

### Integrating Clerk Components for Authentication

Clerk provides several components for managing authentication, such as `SignInButton`, `SignUpButton`, `SignedIn`, `SignedOut`, and `UserButton`. These components handle user authentication states and provide UI elements for signing in, signing up, and displaying user information.

In the Header component (`app/(marketing)/header.tsx`), we integrate these Clerk components to enable authentication functionality:

```tsx
import { ClerkLoaded, ClerkLoading, SignInButton, SignedIn, SignedOut, UserButton } from "@clerk/nextjs";
import { Loader } from "lucide-react";

// Inside the Header component JSX
<ClerkLoading>
    <Loader className="h-5 w-5 text-muted-foreground animate-spin" />
</ClerkLoading>
<ClerkLoaded>
    <SignedIn>
        <UserButton
            afterSignOutUrl="/"
        />
    </SignedIn>
    <SignedOut>
        <SignInButton
            mode="modal"
            afterSignInURL="/learn"
            afterSignUpURL="/learn"
        >
            <Button size="lg" variant="ghost">Login</Button>
        </SignInButton>
    </SignedOut>
</ClerkLoaded>
```

These components ensure that the application behaves appropriately based on the user's authentication status, providing a seamless authentication experience for the users.

<div align="center">
<img src="./imgs/04-Authentication-Page.png" alt="Hero Page with Authentication Setup" width="400px" height="auto">
</div>